---
name: Deploy a standard ECS application

on:
  workflow_call:
    inputs:
      aws_region:
        type: string
        default: "eu-central-1"
      docker_image_tag:
        type: string
        required: true
      environment:
        type: string
        required: true
      extra_args:
        type: string
        default: ""
      notify_on_success:
        type: boolean
        default: false
      self_hosted:
        type: boolean
        default: false
      service:
        type: string
        required: true
      slack_channel:
        type: string
        required: true
      terraform_version:
        type: string
        required: true
      wait_for_stabilization:
        type: boolean
        default: true
      working_directory:
        type: string
        default: "./infra/terraform"

jobs:
  deploy:
    runs-on: ${{ inputs.self_hosted && fromJSON(format('["self-hosted","{0}"]', inputs.environment)) || 'ubuntu-latest' }}
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    env:
      AWS_DEFAULT_REGION: ${{ inputs.aws_region }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      DOCKER_IMAGE_TAG: ${{ inputs.docker_image_tag }}
      ENV: ${{ inputs.environment }}
      EXTRA_ARGS: ${{ inputs.extra_args }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      LOGS_URL: https://app.datadoghq.eu/logs?query=service%3A${{ inputs.service }}%20version%3A${{ inputs.docker_image_tag }}%20env%3A${{ inputs.environment }}
      SERVICE: ${{ inputs.service }}
      TF_WORKSPACE: ${{ inputs.environment }}
      TF_LOG: INFO
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Terraform setup
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Terraform init
        run: terraform init

      - name: Terraform validate
        run: terraform validate

      - name: Notify deployment in progress
        if: inputs.environment  == 'production'
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: deployment-updates-prod
          slack-message: ":ship: New deployment of `${{ inputs.service }}` in progress (version `${{ inputs.docker_image_tag }}`)"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Terraform apply
        run: |
          if !(terraform apply -var "docker_image_tag=${DOCKER_IMAGE_TAG}" -var-file=${ENV}.tfvars -auto-approve -input=false ${EXTRA_ARGS}); then
            echo "/!\/!\/!\ The deployment has failed to stabilize after 10 minutes !"
            echo "It likely means that this new version is crashing on start up."
            echo "You should check the logs to understand what happened: ${LOGS_URL}"
            exit 1
          fi
      - name: Wait for stabilization
        if: ${{ inputs.wait_for_stabilization }}
        run: aws ecs wait services-stable --cluster "main-${ENV}" --service "${SERVICE}"

      - name: Notify success
        if: ${{ inputs.notify_on_success }}
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: ${{ inputs.slack_channel }}
          slack-message: ":white_check_mark: A new version of `${{ inputs.service }}` (version `${{ inputs.docker_image_tag }}`) has been successfully deployed to ${{ env.ENV }} (<${{ env.GITHUB_URL }}|Github Actions>|<${{ env.LOGS_URL }}|Logs>)."
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Notify failure
        if: ${{ failure() }}
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: ${{ inputs.slack_channel }}
          slack-message: ":rotating_siren: The last deployment of `${{ inputs.service }}` (version `${{ inputs.docker_image_tag }}`) to ${{ env.ENV }} has failed (<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Github Actions>)."
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
